- {{embed ((6774c2af-14c3-4554-8164-cfa83fa7e80c))}}
- 一个简单的CUDA grid的模型。假设我们有2x2个线程块，
	- ![image.png](../assets/image_1735552459981_0.png)
	- 上面图里，每个[[线程块]]包含了16个thread，
		- **线程块（Thread Block）** 可以是单个维度（1D）或多个维度（2D 或 3D），这取决于你的 CUDA 核函数的需求以及问题的维度特性。在 CUDA 中，线程块的组织方式由 `blockDim` 参数决定，你可以根据实际需求灵活选择线程块的维度。
		- 为什么要设计成多个维度：
			- 一维：vector运算
			- 二维：矩阵运算
			- 三维：图像数据
		- 线程块中的总线程数不能超过 1024（具体值取决于 GPU 的计算能力）
		- 如何选择线程块维度?
			- **数据维度：**
				- 如果处理的是一维数据（如数组），选择 1D 线程块。
				- 如果处理的是二维数据（如矩阵），选择 2D 线程块。
				- 如果处理的是三维数据（如 3D 体积），选择 3D 线程块。
			- **线程块大小：**
				- 通常选择线程块大小为 32 的倍数，因为 GPU 的 **[[warp]]** 是以 32 个线程为单位调度的。
				- 例如，`16x16` 的二维线程块（256 个线程）是一个常见的选择。
	- 为什么[[线程块]]的上限是1024？
		- 一个线程块最多可以包含 1024 个线程，相当于最多 **1024 ÷ 32 = 32 个 [[Warp]]**。
		- 32 个 Warp 是一个合理的上限，超出这个数量会增加硬件调度器的复杂性，并且可能导致资源管理效率下降。
			- 硬件调度器，dispatcher是如何设计的？
		- 硬件资源限制：
			- Registers
				- 寄存器用于存储局部变量，每个 SM 上的寄存器总量是有限的（例如，NVIDIA Ampere 架构的 SM 有 64k 到 256k 寄存器）。如果线程块的寄存器需求超过了 SM 的总寄存器数量，则无法分配该线程块。
			- Shared Memory
			- 硬件上下文
				- 每个线程的执行上下文（程序计数器、寄存器状态等）需要硬件支持来存储。
				- SM 的硬件调度器需要保存所有线程的上下文以支持零开销线程切换。
	- 如果[[线程块]]的数量超过了32，也就是一次[[warp]]处理的线程数量，会发生什么？
		- 轮流调度
- [[SM]]
-